# Commands for installing and setting up HaProxy Load Balancer on CentOS

vi /etc/hosts
# Adjust the IP addresses and Hostnames to your needs.
192.168.40.10    haproxy-centos8
192.168.40.11    httpd-node01
192.168.40.12    httpd-node02

sudo dnf update

dnf install haproxy

# Create backup for haproxy.cfg
cd /etc/haproxy/
cp haproxy.cfg haproxy.cfg-bk

vi haproxy.cfg
# Adjust the IP addresses and Hostnames to your needs.
frontend http_balancer
    bind 192.168.40.10:80
    option http-server-close
    option forwardfor
    stats uri /haproxy?stats

#    acl url_static       path_beg       -i /static /images /javascript /stylesheets
#    acl url_static       path_end       -i .jpg .gif .png .css .js
#    use_backend static          if url_static
    default_backend     nginx_webservers

backend nginx_webservers
    mode        http
    balance     roundrobin
    option httpchk HEAD / HTTP/1.1rnHost: localhost    
    server  nginx-node01  192.168.40.11:80  check
    server  nginx-node02  192.168.40.12:80  check

# Configure rsyslog for HAProxy logging.
vi /etc/rsyslog.conf
# Uncomment these two lines
module(load="imudp")
input(type="imudp" port="514")

# Create haproxy.conf file for rysyslog
vi /etc/rsyslog.d/haproxy.conf

# Paste the following content into the haproxy.conf file
local2.=info     /var/log/haproxy-access.log
local2.notice    /var/log/haproxy-info.log

# Restart and enable rysyslog
systemctl restart rsyslog
systemctl enable rsyslog

# Set the following selinux rule
setsebool -P haproxy_connect_any 1

# Start & enable haproxy
systemctl start haproxy
systemctl enable haproxy

# Allow port 80 on the haproxy firewall
firewall-cmd --add-port=80/tcp --permanent
firewall-cmd --reload